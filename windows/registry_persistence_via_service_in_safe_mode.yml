- dataTypes:
  - wineventlog
  name: Registry Persistence via Service in Safe Mode
  impact:
    confidentiality: 3
    integrity: 3
    availability: 3
  category: Security Detection
  technique: T1564.001
  adversary: UNKNOWN
  description: Detects the modification of the registry to allow a driver or service
    to persist in Safe Mode.
  references:
  - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1112/T1112.md#atomic-test-33---windows-add-registry-value-to-load-service-in-safe-mode-without-network
  - https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1112/T1112.md#atomic-test-34---windows-add-registry-value-to-load-service-in-safe-mode-with-network
  where: (safe("log.targetObject", "").contains("\\Control\\SafeBoot\\Minimal\\")
    || safe("log.targetObject", "").contains("\\Control\\SafeBoot\\Network\\")) &&
    safe("log.targetObject", "").endsWith("\\(Default)") && safe("log.details", "")
    == "Service" && !(safe("log.image", "") == "C:\\WINDOWS\\system32\\msiexec.exe"
    && (safe("log.targetObject", "").endsWith("\\Control\\SafeBoot\\Minimal\\SAVService\\(Default)")
    || safe("log.targetObject", "").endsWith("\\Control\\SafeBoot\\Network\\SAVService\\(Default)")))
