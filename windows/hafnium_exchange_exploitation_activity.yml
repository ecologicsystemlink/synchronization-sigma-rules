- dataTypes:
  - wineventlog
  name: HAFNIUM Exchange Exploitation Activity
  impact:
    confidentiality: 3
    integrity: 3
    availability: 3
  category: Persistence
  technique: T1546, T1053
  adversary: UNKNOWN
  description: Detects activity observed by different researchers to be HAFNIUM group
    activity (or related) on Exchange servers
  references:
  - https://blog.truesec.com/2021/03/07/exchange-zero-day-proxylogon-and-hafnium/
  - https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/
  - https://discuss.elastic.co/t/detection-and-response-for-hafnium-activity/266289/3
  - https://twitter.com/GadixCRK/status/1369313704869834753?s=20
  - https://twitter.com/BleepinComputer/status/1372218235949617161
  where: safe("log.commandLine", "").contains("attrib") && safe("log.commandLine",
    "").contains(" +h ") && safe("log.commandLine", "").contains(" +s ") && safe("log.commandLine",
    "").contains(" +r ") && safe("log.commandLine", "").contains(".aspx") || safe("log.image",
    "").contains("\\ProgramData\\VSPerfMon\\") || safe("log.commandLine", "").contains("schtasks")
    && safe("log.commandLine", "").contains("VSPerfMon") || safe("log.image", "").endsWith("Opera_browser.exe")
    && (safe("log.parentImage", "").endsWith("\\services.exe") || safe("log.parentImage",
    "").endsWith("\\svchost.exe")) || safe("log.image", "").endsWith("Users\\Public\\opera\\Opera_browser.exe")
    || safe("log.commandLine", "").contains("vssadmin list shadows") && safe("log.commandLine",
    "").contains("Temp\\__output") || safe("log.image", "").endsWith("\\makecab.exe")
    && safe("log.commandLine", "").contains("inetpub\\wwwroot\\") && safe("log.commandLine",
    "").contains(".dmp.zip") || safe("log.image", "").endsWith("\\makecab.exe") &&
    (safe("log.commandLine", "").contains("Microsoft\\Exchange Server\\") || safe("log.commandLine",
    "").contains("compressionmemory") || safe("log.commandLine", "").contains(".gif"))
    || safe("log.commandLine", "").contains(" -t7z ") && safe("log.commandLine", "").contains("C:\\Programdata\\pst")
    && safe("log.commandLine", "").contains("\\it.zip") || safe("log.commandLine",
    "").contains("\\comsvcs.dll") && safe("log.commandLine", "").contains("Minidump")
    && safe("log.commandLine", "").contains("full ") && safe("log.commandLine", "").contains("\\inetpub\\wwwroot")
    || safe("log.commandLine", "").contains("Windows\\Temp\\xx.bat") || safe("log.commandLine",
    "").contains("Windows\\WwanSvcdcs") || safe("log.commandLine", "").contains("Windows\\Temp\\cw.exe")
