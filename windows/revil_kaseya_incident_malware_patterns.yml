- dataTypes:
  - wineventlog
  name: REvil Kaseya Incident Malware Patterns
  impact:
    confidentiality: 3
    integrity: 3
    availability: 3
  category: Execution
  technique: T1059
  adversary: UNKNOWN
  description: Detects process command line patterns and locations used by REvil group
    in Kaseya incident (can also match on other malware)
  references:
  - https://community.sophos.com/b/security-blog/posts/active-ransomware-attack-on-kaseya-customers
  - https://www.joesandbox.com/analysis/443736/0/html
  - https://doublepulsar.com/kaseya-supply-chain-attack-delivers-mass-ransomware-event-to-us-companies-76e4ec6ec64b
  - https://therecord.media/revil-ransomware-executes-supply-chain-attack-via-malicious-kaseya-update/
  - https://blog.truesec.com/2021/07/04/kaseya-supply-chain-attack-targeting-msps-to-deliver-revil-ransomware/
  where: safe("log.commandLine", "").contains("C:\\Windows\\cert.exe") || safe("log.commandLine",
    "").contains("del /q /f c:\\kworking\\agent.crt") || safe("log.commandLine", "").contains("Kaseya
    VSA Agent Hot-fix") || safe("log.commandLine", "").contains("\\AppData\\Local\\Temp\\MsMpEng.exe")
    || safe("log.commandLine", "").contains("rmdir /s /q %SystemDrive%\\inetpub\\logs")
    || safe("log.commandLine", "").matches(".*del /s /q /f %SystemDrive%\\\\.*\\.log.*")
    || safe("log.commandLine", "").contains("c:\\kworking1\\agent.exe") || safe("log.commandLine",
    "").contains("c:\\kworking1\\agent.crt") || safe("log.image", "") == "C:\\Windows\\MsMpEng.exe"
    || safe("log.image", "") == "C:\\Windows\\cert.exe" || safe("log.image", "") ==
    "C:\\kworking\\agent.exe" || safe("log.image", "") == "C:\\kworking1\\agent.exe"
    || safe("log.commandLine", "").contains("del /s /q /f") && safe("log.commandLine",
    "").contains("WebPages\\Errors\\webErrorLog.txt")
