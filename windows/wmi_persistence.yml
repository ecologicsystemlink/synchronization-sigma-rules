- dataTypes:
  - wineventlog
  name: WMI Persistence
  impact:
    confidentiality: 2
    integrity: 2
    availability: 2
  category: Persistence
  technique: T1546.003
  adversary: UNKNOWN
  description: Detects suspicious WMI event filter and command line event consumer
    based on WMI and Security Logs.
  references:
  - https://twitter.com/mattifestation/status/899646620148539397
  - https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/
  where: (safe("log.eventCode", 0.0) == double(5861) && (""safe("log.activeScriptEventConsumer",
    "")"" || ""safe("log.commandLineEventConsumer", "")"" || ""safe("log.commandLineTemplate",
    "")"") || safe("log.eventCode", 0.0) == double(5859)) && !(safe("log.provider",
    "") == "SCM Event Provider" && safe("log.query", "").matches("select .* from MSFT_SCMEventLogEvent")
    && safe("log.user", "") == "S-1-5-32-544" && safe("log.possibleCause", "") ==
    "Permanent")
